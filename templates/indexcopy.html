<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Graph Visualizer</title>
		<script src="https://d3js.org/d3.v6.min.js"></script>
	</head>
	<body>
		<div id="graph"></div>

		<script>
			function drawGraph(graph) {
				document.getElementById('graph').innerHTML = ''; // Clear the previous graph
				const width = 800,
					height = 600;
				const svg = d3
					.select('#graph')
					.append('svg')
					.attr('width', width)
					.attr('height', height);

				// Define color mapping based on labels
				const color = d3
					.scaleOrdinal()
					.domain(['UAV', 'BackboneUAV', 'GroundStation', 'None']) // Add all expected labels
					.range(['blue', 'green', 'teal', 'grey']); // Corresponding colors

				const links = svg
					.selectAll('.link')
					.data(graph.links)
					.enter()
					.append('line')
					.attr('class', 'link')
					.style('stroke', '#aaa');

				const nodes = svg
					.selectAll('.node')
					.data(graph.nodes)
					.enter()
					.append('circle')
					.attr('class', 'node')
					.attr('r', 12)
					.style('fill', (d) => color(d.label));

				const simulation = d3
					.forceSimulation(graph.nodes)
					.force(
						'link',
						d3
							.forceLink(graph.links)
							.id((d) => d.id)
							.distance(50),
					)
					.force('charge', d3.forceManyBody().strength(-75))
					.force('center', d3.forceCenter(width / 2, height / 2))
					.force('collision', d3.forceCollide().radius(15));

				simulation.on('tick', () => {
					links
						.attr('x1', (d) => d.source.x)
						.attr('y1', (d) => d.source.y)
						.attr('x2', (d) => d.target.x)
						.attr('y2', (d) => d.target.y);

					nodes
						.attr('cx', (d) => Math.max(5, Math.min(width - 5, d.x)))
						.attr('cy', (d) => Math.max(5, Math.min(height - 5, d.y)));
				});
			}

			function fetchGraph() {
				fetch('/graph')
					.then((response) => response.json())
					.then((graph) => {
						console.log(graph); // Log the graph data to check
						drawGraph(graph);
					});
			}

			fetchGraph();
			setInterval(fetchGraph, 10000); // Refresh graph every 10 seconds
		</script>
	</body>
</html>
